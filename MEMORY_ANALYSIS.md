# 项目内存占用分析

## 项目规模统计

- **TypeScript 文件数**: 201 个
- **代码总行数**: 约 25,869 行
- **依赖包数量**: 44 个生产依赖 + 26 个开发依赖

## 内存占用大的主要原因

### 1. 大型依赖库（主要因素）🔥

#### ⚠️ Monaco Editor（最大占用）
- **包大小**: ~50MB（未压缩）
- **位置**: `monaco-editor@^0.52.2`
- **使用位置**: `src/pages/editor/monaco-react/index.tsx`
- **内存占用**: 构建时需要加载整个编辑器代码
- **问题**: 
  - 包含完整的语言服务器
  - 多个 Worker 文件（editor, json, css, html, typescript）
  - 构建时需要解析所有语言特性

#### ⚠️ Three.js + React Three Fiber（第二大）
- **包大小**: 
  - `three@^0.175.0`: ~15MB
  - `@react-three/fiber`: ~5MB
  - `@react-three/drei`: ~3MB
- **使用位置**: `src/pages/visualization/threejs/index.tsx`
- **内存占用**: 3D 渲染库，包含大量数学计算和图形处理代码
- **问题**: 
  - 需要处理 GLTF 模型加载
  - 环境贴图（HDR）处理
  - 复杂的 3D 场景计算

#### ⚠️ PDF.js（第三大）
- **包大小**: `pdfjs-dist@^5.4.449`: ~10MB
- **使用位置**: `src/pages/document/pdf-preview/index.tsx`
- **内存占用**: PDF 解析和渲染库
- **问题**: 
  - 包含完整的 PDF 解析引擎
  - Worker 文件处理
  - 字体和图像处理

#### ⚠️ Ant Design（UI 库）
- **包大小**: `antd@^5.15.2`: ~15MB
- **使用位置**: 全项目广泛使用
- **内存占用**: 虽然大，但是必需的 UI 库
- **问题**: 
  - 包含大量组件和样式
  - 国际化文件
  - 图标库

### 2. TypeScript 编译阶段

#### 类型检查内存占用
- **所有类型定义**: 需要加载所有 `@types/*` 包
- **类型推导**: TypeScript 需要推导所有类型
- **项目规模**: 201 个文件，25,869 行代码
- **估计内存**: 800MB - 1.2GB

#### 大型库的类型定义
- `@types/three`: Three.js 类型定义（很大）
- `@types/react`: React 类型定义
- `@types/node`: Node.js 类型定义
- 其他各种类型定义

### 3. Vite 构建阶段

#### 依赖预构建
- **依赖数量**: 70+ 个包
- **需要处理**: 
  - CommonJS 转 ESM
  - 依赖关系分析
  - 代码转换
- **估计内存**: 1.5GB - 2.5GB

#### 代码转换和打包
- **源代码**: 201 个文件
- **需要处理**: 
  - JSX 转换
  - TypeScript 转 JavaScript
  - CSS 处理（Tailwind, Less, Sass）
  - 资源处理（图片、字体等）
- **估计内存**: 500MB - 1GB

#### 压缩和优化
- **esbuild 压缩**: 比 terser 占用更少，但仍需要内存
- **CSS 压缩**: PostCSS 处理
- **估计内存**: 300MB - 500MB

## 内存占用分解

### 构建过程内存峰值

```
TypeScript 编译阶段:
├─ 类型系统加载: ~800MB
├─ 类型检查: ~400MB
└─ 总计: ~1.2GB

Vite 构建阶段:
├─ 依赖预构建: ~1.5GB
├─ 代码转换: ~800MB
├─ 打包和压缩: ~500MB
└─ 总计: ~2.8GB

同时运行（tsc && vite）:
└─ 峰值: ~3.5GB - 4GB ❌
```

## 优化建议

### 1. 已实施的优化 ✅
- 分离 TypeScript 和 Vite 构建
- 使用 esbuild 替代 terser
- 内存限制设置为 2.5GB

### 2. 可以进一步优化

#### 选项 A: 启用代码分割（推荐）
取消注释 `vite.config.ts` 中的 `manualChunks`，将大型库单独打包：
- 减少单次处理的内存占用
- 构建时间可能增加 10-20%

#### 选项 B: 按需加载 Monaco Editor
如果可能，考虑：
- 使用 CDN 加载 Monaco Editor
- 或者只在需要时动态导入

#### 选项 C: 增加 Swap 空间
在服务器上增加 4GB Swap，允许内存溢出到磁盘

#### 选项 D: 使用 CI/CD 构建
在资源充足的 CI/CD 环境中构建，然后推送镜像到服务器

## 结论

**主要问题**：
1. **Monaco Editor** 是最大的内存占用者（~50MB 包，构建时占用 ~1GB 内存）
2. **Three.js** 是第二大占用者（~20MB 包，构建时占用 ~600MB 内存）
3. **PDF.js** 是第三大占用者（~10MB 包，构建时占用 ~400MB 内存）
4. **项目规模**：201 个文件，25,869 行代码，需要大量内存进行类型检查和构建

**当前配置（2.5GB）是合理的**，如果仍然失败，建议：
1. 增加 Swap 空间（最简单）
2. 启用代码分割（减少峰值内存）
3. 考虑在 CI/CD 中构建

